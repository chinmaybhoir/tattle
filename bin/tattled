#!/usr/bin/env python
import argparse
import asyncio

from tornado import ioloop
from tornado import httpserver
from tornado.platform.asyncio import AsyncIOMainLoop

import tattle
import tattle.logging

LOG = tattle.logging.get_logger('tattled')


def _parse_address(address):
    if ':' in address:
        host, _, port = address.partition(':')
        return host, int(port)
    return address, None


def _parse_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument("-n", "--name", type=str,
                        help="node name")
    parser.add_argument("-a", "--address", type=str,
                        help="node address")
    parser.add_argument("-b", "--bind", type=str,
                        help="bind address")
    parser.add_argument("-v", "--verbose", action="store_true",
                        help="verbose output")
    return parser.parse_args()


if __name__ == '__main__':
    AsyncIOMainLoop().install()

    # parse arguments
    args = _parse_arguments()

    # init config
    config = tattle.init_config()

    if args.name is not None:
        config.node_name = args.name

    if args.address is not None:
        node_address, node_port = _parse_address(args.address)
        if node_address is not None:
            config.node_address = node_address
        if node_port is not None:
            config.node_port = node_port

    if args.bind is not None:
        bind_address, bind_port = _parse_address(args.bind)
        if bind_address is not None:
            config.bind_address = bind_address
        if bind_port is not None:
            config.bind_port = bind_port

    # init logging
    logger = tattle.logging.init_logger(tattle.logging.DEBUG)

    # initialize cluster
    cluster = tattle.Cluster(config)

    # initialize API
    api = tattle.APIServer(cluster)

    # start http server
    http = httpserver.HTTPServer(api)
    http.listen(config.api_port, address=config.api_address)
    LOG.info("API server listening on %s:%s", config.api_address, config.api_port)

    # from tornado.platform.asyncio import AsyncIOMainLoop

    # start cluster
    # asyncio.ensure_future(cluster.start())
    # asyncio.get_event_loop().run_forever()

    # # lets go!
    # ioloop.IOLoop.configure('tornado.platform.asyncio.AsyncIOLoop')
    # ioloop.IOLoop.current().start()
    asyncio.ensure_future(cluster.start())
    ioloop.IOLoop.current().start()
